<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

</head>
<body>
<div class="container">
    <div id="content">
        <div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <h3 id="myModalLabel">Modal header</h3>
            </div>
            <div class="modal-body">
                <img src="ajax-loader.gif"/>
            </div>
            <div class="modal-footer">
            </div>
        </div>
        <!--<div id='loading-indicator' style="position: fixed; left: 50%; top: 50%; display: none;">-->
        <!--<img src="/ajax-loader.gif"></img>-->
        <!--</div>-->
        <ul class="nav nav-tabs" data-tabs="tabs">
            <li class="active"><a href="#home" data-toggle="tab">Wellcome</a></li>
            <li><a href="#scantab" data-toggle="tab">Scan Directories</a></li>
            <li><a href="#search" data-toggle="tab">Search Photos</a></li>
        </ul>
        <div id="my-tab-content" class="tab-content">
            <div class="tab-pane active" id="home">
                Registered machines :
                <ul id="machineList" class="list-group"></ul>
                <button type="button" name="refresh" onclick="getRegisteredMachines()" value="refresh" class="btn btn-primary start">
                    <span>refresh</span>
                </button>
            </div>

            <div class="tab-pane" id="scantab">
                <div class="form-group">
                    <label for="activeMachineList">Select one machine:</label>
                    <select class="form-control" id="activeMachineList">
                    </select>
                </div>
                <form class="form-inline">
                    <div class="form-group">
                        Search the folders to index and scan : <input type="text" id="folderValue" name="folderValue" class="form-control">
                        <button type="button" name="Search folder" onclick="submitSearch()" value="Search folder" class="btn btn-primary start">
                            <span>Search Folder</span>
                        </button>
                    </div>
                    <br>
                    Submit all folders to scan
                    <button type="button" name="Scan folder" onclick="submitScan()" value="Scan folder" class="btn btn-primary start">
                        <span>Scan Folder</span>
                    </button>
                </form>
                <div>
                    <input class="search-input form-control">
                </div>
                <div id="jstree"></div>
            </div>
            <div class="tab-pane" id="search">
                <form class="form-inline">
                    <div class="form-group">
                        <div class="offset8">Enter extension image file to search : <select class="form-control" id="extensionList"> </select>

                            <br>
                            <div class="offset8">Enter exif tag of the image file to search :<input type="text" id="exifTagValue" name="exifTagValue"
                                                                                                    class="form-control"></div>
                            <br>
                            <div class="offset8">Enter exif value of the image file to search :<input type="text" id="exifValue" name="exifValue"
                                                                                                      class="form-control"></div>
                            <br>
                            <div class="offset8">Enter part of the filename of the image file to search :<input type="text" id="filename"
                                                                                                                name="filename"
                                                                                                                class="form-control"></div>
                            <br>
                            <button type="button" name="Find images" onclick="submitImagesSearch()" value="Find images" class="btn btn-primary start">
                                <span>Search Images</span>
                            </button>
                            <br>
                            <ul id="imagesFound" class="list-group"></ul>
                        </div>
                    </div>
                </form>
            </div>

            <script>
                $(document).ready(function () {
                    getRegisteredMachines();
                    getExtensionList();
                });

                function getExtensionList() {
                    $(function () {
                        $.ajax({
                            dataType: "json",
                            url: "/getfileextension",
                            type: 'GET',
                            success: function (jsondata, codeHttp) {
                                console.log(jsondata);
                                $('#extensionList').empty();
                                $.each(jsondata.Extensions, function (i, item) {
                                    $('#extensionList').append('<option value="' + item + '">' + item + '</option>');
                                });
                            }
                        })
                    })
                }


                var ExtensionSelected = "";


                function submitImagesSearch() {
                    $(function () {
                        exifTag = $('#exifTagValue').val();
                        exifValue = $('#exifValue').val();
                        $('#extensionList').each(function () {
                            ExtensionSelected = $(this).val();
                        });
                        if (exifTag == "" && exifValue == "" && ExtensionSelected != "") {
                            $.ajax({
                                dataType: "json",
                                url: "/queryextension?value=" + ExtensionSelected,
                                type: 'GET',
                                success: function (jsondata, codeHttp) {
                                    console.log(jsondata);
                                    $('#imagesFound').empty();
                                    if (jQuery.isEmptyObject(jsondata)) {
                                        alert("No images found.");
                                    } else {
                                        $.each(jsondata, function (i, item) {
                                            $('#imagesFound').append('<option value="' + item.filepath + '">' + item.filename + '</option>');
                                        });
                                    }
                                }
                            })
                        } else {
                            console.log("Calling /queryexif?value=" + exifValue + "&exif=" + exifTag);
                            $.ajax({
                                dataType: "json",
                                url: "/queryexif?value=" + exifValue + "&exif=" + exifTag,
                                type: 'GET',
                                success: function (jsondata, codeHttp) {
                                    $('#imagesFound').empty();
                                    if (jQuery.isEmptyObject(jsondata)) {
                                        alert("No images found.");
                                    } else {
                                        $.each(jsondata, function (i, item) {
                                            $('#imagesFound').append('<option value="' + item.filepath + '">' + item.filename + '</option>');
                                        });
                                    }
                                }
                            })
                        }
                    });
                }

                function getRegisteredMachines() {
                    $(function () {
                        $.ajax({
                            dataType: "json",
                            url: "/registeredslaves",
                            type: 'GET',
                            success: function (jsondata, codeHttp) {
                                //console.log(jsondata);
                                $('#machineList').empty();
                                $('#activeMachineList').empty();
                                var listContainer = $("#machineList");
                                var selectPicker = $("#activeMachineList");
                                // event.preventDefault();
                                for (i = 0; i < jsondata.length; i++) {
                                    console.log("adding " + jsondata[i].ipv4);
                                    listContainer.prepend('<li class="list-group-item">' + jsondata[i].ipv4 + '</li>');
                                    selectPicker.append('<option value="' + jsondata[i].machineId + '">' + jsondata[i].ipv4 + '</option>');
                                }
                            }
                        });
                    })
                }


                $(".search-input").keyup(function () {
                    var searchString = $(this).val();
                    //    console.log(searchString);
                    $('#jstree').jstree('search', searchString);
                });

                var MachineID = "";


                function submitSearch() {
                    $(function () {
                        $('#myModal').modal('show');
                        var folderValue = $("#folderValue").val();
                        $('#activeMachineList').each(function () {
                            MachineID = $(this).val();
                        });
                        if (MachineID == "") {
                            alert("Please select a machine before");
                        } else {
                            console.log(MachineID);
                            $.ajax({
                                dataType: "json",
                                url: "browse?value=" + folderValue + "&machineId=" + MachineID,
                                type: 'GET',
                                success: function (jsondata, codeHttp) {
                                    console.log(codeHttp);
                                    if (jsondata.error_message != null) {
                                        alert(jsondata.error_message);
                                    } else {
                                        if (codeHttp == 'success') {


                                            $('#jstree').jstree({
                                                'core': {
                                                    'check_callback': true
                                                },
                                                "checkbox": {
                                                    "keep_selected_style": false
                                                },
                                                "search": {
                                                    "case_insensitive": true,
                                                    "show_only_matches": true
                                                },
                                                "plugins": ["checkbox", "search"]
                                            });
                                            $("#jstree").jstree(true).settings.core.data = jsondata;
                                            $("#jstree").jstree(true).refresh();
                                        }
                                    }
                                }
                            });
                        }
                        $('#myModal').modal('hide');
                    });
                }

                function submitScan() {
                    var machineid = $('#jstree').jstree(true)._model.data['#'].original.machineid;
                    console.log(machineid);
                    var checked = $('#jstree').jstree(true).get_selected();
                    var a = [];
                    for (i = 0; i < checked.length; i++) {
                        var o = {};
                        o = checked[i];
                        a[i] = o;
                    }
                    var body = {};
                    body.folders_toscan = a;
                    body.machineid = machineid;
                    var jsondata = JSON.stringify(body);
                    // console.log(jsondata);
                    $.ajax({
                        dataType: "json",
                        url: "scan",
                        type: 'POST',
                        data: jsondata,
                        success: function (responsedata, codeHttp) {
                            if (codeHttp == "success") {
                                alert(responsedata);
                            }
                        }
                    });
                    console.log(checked);
                }
            </script>
        </div>
    </div>
</div>

</body>
</html>
