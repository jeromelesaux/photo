<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.css">
</head>
<body>
<div class="container">
    <div id="content">

        <div id="loadingImage"
             style="display: none; position:fixed; z-index: 1104; background:url(ajax-loader.gif) no-repeat center center #D3D3D3; opacity: 0.5; width:100%;height: 100%">
        </div>
        <ul class="nav nav-tabs" data-tabs="tabs">
            <li class="active"><a href="#home" data-toggle="tab">Wellcome</a></li>
            <li><a href="#scantab" data-toggle="tab">Scan Directories</a></li>
            <li><a href="#search" data-toggle="tab">Search Photos</a></li>
            <li><a href="#albums" data-toggle="tab">Manage your albums</a></li>
            <li><a href="#history" data-toggle="tab">History actions</a></li>
        </ul>
        <div id="my-tab-content" class="tab-content">
            <!-- application configuration -->
            <div class="tab-pane active" id="home">
                Registered machines :
                <ul id="machineList" class="list-group"></ul>
                <button type="button" name="refresh" onclick="refresh()" value="refresh" class="btn btn-primary start">
                    <span>refresh</span>
                </button>
                <div class="panel panel-default">
                    <div class="panel-heading">Google Account settings</div>
                    <div class="panel-body">
                        <!-- gallery of images found and returned by server -->
                        <div class="row">
                            <form id="googleConfigurationForm">
                                Google User ID <input type="text" id="googleUserId" class="form-control">
                                Google ID<input type="text" id="googleId" class="form-control">
                                Google Secret Phrase<input type="password" id="googleSecret" class="form-control">
                            </form>
                            <button type="button" name="save google account" onclick="saveAndImportGoogleAccount()"
                                    value="save and import google account"
                                    class="btn btn-primary start">
                                <span>Save and import google account</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">Flickr Account settings</div>
                    <div class="panel-body">
                        <!-- gallery of images found and returned by server -->
                        <div class="row">
                            <form id="flickrConfigurationForm">
                                Flickr API Key <input type="text" id="flickrApiKey" class="form-control">
                                Flickr API Secret<input type="password" id="flickrApiSecret" class="form-control">
                                Flickr Oauth verifier Token :<input type="text" id="flickrToken"
                                                                    name="flickrToken"
                                                                    class="form-control">
                            </form>
                            <button type="button" class="btn btn-primary start" data-toggle="modal" data-target="#flickrOauthVerifer">
                                <span>Get flickr token to import albums</span>
                            </button>
                            <button type="button" class="btn btn-primary start" data-dismiss="modal" onclick="goImportFlickrAlbum()">
                                <span>import flickr albums</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- modal page to set flickr account settings -->
                <div id="flickrOauthVerifer" class="modal fade" role="dialog">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Flickr Oauth verifier token</h4>
                            </div>
                            <div class="modal-body">
                                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="goFlickr()">Get the flickr token
                                </button>
                            </div>
                            <div class="modal-footer">

                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="tab-pane" id="scantab">
                <div class="form-group">
                    <label for="activeMachineList">Select one machine:</label>
                    <select class="form-control" id="activeMachineList">
                    </select>
                </div>
                <form class="form-inline">
                    <div class="form-group">
                        Search the folders to index and scan : <input type="text" id="folderValue" name="folderValue" class="form-control">
                        <button type="button" name="Search folder" onclick="submitSearch()" value="Search folder" class="btn btn-primary start">
                            <span>Search Folder</span>
                        </button>
                    </div>
                    <br>
                    Submit all folders to scan
                    <button type="button" name="Scan folder" onclick="submitScan()" value="Scan folder" class="btn btn-primary start">
                        <span>Scan Folder</span>
                    </button>
                </form>
                <div>
                    <input class="search-input form-control">
                </div>
                <div id="jstree"></div>
            </div>
            <div class="tab-pane" id="search">
                <form class="form-inline">
                    <div class="form-group">
                        <div class="panel panel-default">
                            <div class="panel-heading">Search Criteria</div>
                            <div class="panel-body">
                                <div class="offset8">Enter extension image file to search : <select class="form-control" id="extensionList"> </select>
                                    <select class="form-control" id="fileSize">
                                        <option value="big">big size</option>
                                        <option value="medium">meduim size</option>
                                        <option value="little">little size</option>
                                    </select>
                                    <br>
                                    <div class="offset8">Enter exif tag of the image file to search :<input type="text" id="exifTagValue"
                                                                                                            name="exifTagValue"
                                                                                                            class="form-control"></div>
                                    <br>
                                    <div class="offset8">Enter exif value of the image file to search :<input type="text" id="exifValue"
                                                                                                              name="exifValue"
                                                                                                              class="form-control"></div>
                                    <br>
                                    <div class="offset8">Enter part of the filename of the image file to search :<input type="text" id="filename"
                                                                                                                        name="filename"
                                                                                                                        class="form-control"></div>
                                    <br>
                                    <button type="button" name="Find images" onclick="submitImagesSearch()" value="Find images"
                                            class="btn btn-primary start">
                                        <span>Search Images</span>
                                    </button>
                                    <button type="button" name="clean " onclick="clean()" value="clean" class="btn btn-primary start">
                                        <span>clean</span>
                                    </button>
                                    <button type="button" name="clean " onclick="cleanDatabase()" value="clean database"
                                            class="btn btn-primary start">
                                        <span>clean database</span>
                                    </button>
                                    <button type="button" class="btn btn-info start" data-toggle="modal" data-target="#createNewAlbum">Create new
                                        album
                                    </button>
                                    <button type="button" class="btn btn-info start" data-toggle="modal" data-target="#updateExistingAlbum">Update an
                                        existing album
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <div class="panel panel-default">
                    <div class="panel-heading">Images found.</div>
                    <div class="panel-body">
                        <!-- number of images returned by server -->
                        <div id="imagesFoundNumber"></div>
                        <!-- gallery of images found and returned by server -->
                        <div class="row">
                            <div id="imagesFound">
                            </div>
                        </div>
                    </div>
                </div>


                <!-- modal page to create new album -->
                <div id="createNewAlbum" class="modal fade" role="dialog">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Create new album</h4>
                            </div>
                            <div class="modal-body">
                                <div class="offset8">Enter the new album new of your photo's selection :<input type="text" id="albumname"
                                                                                                               name="albumname"
                                                                                                               class="form-control"></div>

                                <div class="offset8">Enter the album description :<input type="text" id="albumDescription"
                                                                                         name="albumDescription"
                                                                                         class="form-control"></div>

                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="createalbum()">Create Album
                                </button>
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- modal page to update an album -->
                <div id="updateExistingAlbum" class="modal fade" role="dialog">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Update an existing album</h4>
                            </div>
                            <div class="modal-body">
                                <label for="updateAlbumList">Select an existing Album:</label>
                                <select class="form-control" id="updateAlbumList">
                                </select>
                                <div class="offset8">Album Name :<input type="text" id="updateAlbumName"
                                                                        name="updateAlbumName"
                                                                        class="form-control"></div>
                                <div class="offset8">Album description :<input type="text" id="updateAlbumDescription"
                                                                               name="updateAlbumDescription"
                                                                               class="form-control"></div>

                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal" onclick="mergeAlbum()">Update Album
                                </button>
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- tab to display albums -->
            <div class="tab-pane" id="albums">
                <button type="button" name="Retreive the albums list" onclick="listAlbums()" value="Retreive the albums list"
                        class="btn btn-primary start">
                    <span>Retreive the albums list</span>
                </button>
                <div class="form-group">
                    <span class="glyphicon glyphicon-search"></span>
                    <input class="input-control" type="text" id="keySearch" onkeyup="searchKeyword()" placeholder="Search for albums..">
                    <button type="button" class="btn btn-default" onclick="cleanKeyword()">X</button>
                    <!--<button type="button" class="btn btn-primary start" onclick="selectGoogleAlbums()">Google Albums</button>-->
                    <!--<button type="button" class="btn btn-primary start" onclick="selectFlickrAlbums()">Flickr Albums</button>-->
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">Albums</div>
                    <div class="panel-body">

                        <div id="albumListId" class="btn-group">
                        </div>
                    </div>
                </div>
                <br>

                <div class="panel panel-default">
                    <div class="panel-heading">Albums photos</div>
                    <div class="panel-body">
                        <div class="panel panel-default">
                            <div class="panel-heading">Album Description</div>
                            <button type="button" name="Update the album" onclick="updateAlbumView()" value="Update the album"
                                    class="btn btn-info start">
                                <span>update the album</span>
                            </button>
                            <button type="button" name="Delete the album" onclick="deleteAlbum()" value="Delete the album"
                                    class="btn btn-info start">
                                <span>delete the album</span>
                            </button>
                            <button type="button" name="Delete the selected photos of the album" onclick="deletePhotosAlbum()"
                                    value="Delete selected photos from the album"
                                    class="btn btn-info start">
                                <span>delete selected photos from the album</span>
                            </button>
                            <button type="button" name="Clear photos selection"
                                    id="uncheckAlbumsSelection"
                                    value="Clear photos selection"
                                    class="btn btn-info start">
                                <span>clear photos selection</span>
                            </button>
                            <button type="button" name="Download pdf album" onclick="getPdfAlbum()"
                                    value="Download pdf album"
                                    class="btn btn-info start">
                                <span>Download pdf album</span>
                            </button>
                            <div class="panel-body">
                                <input type="text" id="albumDescriptionId"
                                       name="albumDescriptionId"
                                       class="form-control">

                            </div>
                        </div>
                        <!-- gallery of the album found and returned by server -->
                        <div class="row">
                            <input type="text" id="albumNameId"
                                   name="albumNameId"
                                   class="form-control">
                            <div id="albumImagesFound"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane" id="history">
                <div class="panel panel-default">
                    <div class="panel-heading">application actions history
                        <button id="refreshTable" class="btn btn-default" onclick="refreshTable()">Refresh data</button>
                    </div>
                    <div class="panel-body">
                        <table data-toggle="table" class="display" data-url="./history" id="tableActionsMessages"
                               data-sort-name="date" data-sort-order="desc">
                            <tr>
                                <td>actions messages</td>
                            </tr>
                            <thead>
                            <tr>
                                <th data-field="date" data-sortable="true">date</th>
                                <th data-field="message" data-sortable="false">message</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
            <style type="text/css">
                img {
                    filter: gray; /* IE6-9 */
                    -webkit-filter: grayscale(0); /* Google Chrome, Safari 6+ & Opera 15+ */
                    -webkit-box-shadow: 0px 2px 6px 2px rgba(0, 0, 0, 0.75);
                    -moz-box-shadow: 0px 2px 6px 2px rgba(0, 0, 0, 0.75);
                    box-shadow: 0px 2px 6px 2px rgba(0, 0, 0, 0.75);
                    margin-bottom: 20px;
                }

                img:hover {
                    filter: none; /* IE6-9 */
                    -webkit-filter: grayscale(0);
                }

                /* Google Chrome, Safari 6+ & Opera 15+ */

            </style>

            <script>
                $(document).ready(function () {
                    getRegisteredMachines();
                    getExtensionList();
                    loadGoogleAccount();
                    loadFlickrAccount();
                    $("#uncheckAlbumsSelection").click(function () {
                        $(this).find('input.album[type=checkbox]').prop("checked", false);
                    })
                });

                $(function () {
                    $(document).ajaxStart(function () {
                        $('#loadingImage').show();
                    });

                    $(document).ajaxStop(function () {
                        $('#loadingImage').hide();
                    });
                });


                // script javascript to manage selection of the photo
                $("body").on("click", 'label',
                    function (event) {
                        input = $(this).find(":checkbox");
                        if (input.is(":checked") === false) {
                            input.prop('checked', true);
                            console.log("checked");
                            $(this).animate({'opacity': '0.5'}, 350);
                        } else {
                            input.prop('checked', false);
                            console.log("unchecked");
                            $(this).animate({'opacity': '1'}, 150);
                        }
                        event.preventDefault();
                    });

                function refreshTable() {
                    table = $('#tableActionsMessages');
                    table.bootstrapTable('refresh');
                }

                function cleanKeyword() {
                    $('#keySearch').val("");
                }

                function searchKeyword() {
                    var input, filter, albums;
                    input = document.getElementById("keySearch");
                    filter = input.value.toUpperCase();
                    albums = document.getElementById("albumListId").childNodes;
                    for (i = 0; i < albums.length; i++) {
                        var label = albums[i].innerText.toUpperCase();
                        if (label.indexOf(filter) === -1) {
                            albums[i].style.display = "none";
                        } else {
                            albums[i].style.display = "";
                        }
                    }

                }


                function loadFlickrAccount() {
                    $(function () {
                        $.ajax({
                            dataType: "json",
                            url: "flickrload",
                            type: 'GET',
                            success: function (responsedata, codeHttp) {
                                if (codeHttp === "success") {
                                    $('#flickrApiKey').val(responsedata.api_key);
                                    $('#flickrApiSecret').val(responsedata.api_secret);
                                    $('#flickrToken').val(responsedata.flickr_token);
                                }
                            }
                        });
                    })
                }

                function goImportFlickrAlbum() {
                    $(function () {
                        flickrKey = $('#flickrApiKey').val();
                        flickrSecret = $('#flickrApiSecret').val();
                        flickrToken = $('#flickrToken').val();
                        var body = {};
                        body.api_key = flickrKey;
                        body.api_secret = flickrSecret;
                        body.flickr_token = flickrToken;
                        var jsondata = JSON.stringify(body);
                        $.ajax({
                            dataType: "json",
                            url: "flickrloadalbums",
                            type: 'POST',
                            data: jsondata,
                            success: function (responsedata, codeHttp) {
                                if (codeHttp === "success") {
                                    alert(responsedata);
                                }
                            }
                        });
                    })
                }

                function goFlickr() {
                    $(function () {
                        flickrKey = $('#flickrApiKey').val();
                        flickrSecret = $('#flickrApiSecret').val();
                        var body = {};
                        body.api_key = flickrKey;
                        body.api_secret = flickrSecret;
                        var jsondata = JSON.stringify(body);
                        $.ajax({
                            dataType: "json",
                            url: "flickrsave",
                            type: 'POST',
                            data: jsondata,
                            success: function (responsedata, codeHttp) {
                                if (codeHttp === "success") {
                                    msg = "Go and set the flickr token after authorization " + responsedata.url_authorization;
                                    alert(msg);
                                }
                            }
                        });
                    })
                }

                function saveAndImportGoogleAccount() {
                    $(function () {
                        googleUserId = $('#googleUserId').val();
                        googleId = $('#googleId').val();
                        googleSecret = $('#googleSecret').val();
                        var body = {};
                        body.id = googleId;
                        body.secret = googleSecret;
                        body.user_id = googleUserId;
                        var jsondata = JSON.stringify(body);
                        console.log(jsondata);
                        $.ajax({
                            dataType: "json",
                            url: "googlesave",
                            type: 'POST',
                            data: jsondata,
                            success: function (responsedata, codeHttp) {
                                if (codeHttp === "success") {
                                    alert(responsedata);
                                }
                            }
                        });
                    })
                }

                function loadGoogleAccount() {
                    $(function () {
                        $.ajax({
                            dataType: "json",
                            url: "googleload",
                            type: 'GET',
                            success: function (responsedata, codeHttp) {
                                if (codeHttp === "success") {
                                    $('#googleUserId').val(responsedata.user_id);
                                    $('#googleId').val(responsedata.id);
                                    $('#googleSecret').val(responsedata.secret);
                                }
                            }
                        });
                    })
                }

                function getPdfAlbum() {
                    $(function () {
                        var values = [];
                        var valuesUrl = "";
                        var partial = false;
                        $('input.album[type=checkbox]').each(function () {
                            if ($(this).is(":checked") === true) {
                                values.push($(this).val());
                            }
                        });
                        albumName = $('#albumNameId').val();
                        if (values.length > 0) {
                            if (confirm("You have selected " + values.length + " photos for the pdf. Do you want to create a pdf with only this selection ?") === true) {
                                for (i = 0; i < values.length; i++) {
                                    valuesUrl += values[i];
                                    if ((i + 1) < values.length) {
                                        valuesUrl += ",";
                                    }
                                }
                                valuesUrl += "";
                                partial = true;
                                //console.log(valuesUrl);
                            } else {
                                return;
                            }
                        }

                        url = "pdfalbum?albumName=" + albumName;
                        if (partial) {
                            url += "&photosid=" + valuesUrl;
                        }
                        console.log(url);
                        // Get file name from url.
                        var filename = albumName + ".pdf";
                        var xhr = new XMLHttpRequest();
                        xhr.responseType = 'blob';
                        xhr.onload = function () {
                            var a = document.createElement('a');
                            a.href = window.URL.createObjectURL(xhr.response); // xhr.response is a blob
                            a.download = filename; // Set the file name.
                            a.style.display = 'none';
                            document.body.appendChild(a);
                            a.click();
                            delete a;
                        };
                        xhr.open('GET', url);
                        xhr.send();

                    })
                }

                function clearSelectionAlbum() {
                    $(function () {
                        $(this).find('input.album[type=checkbox]').prop("checked", false);
//                        $('input.album[type=checkbox]').attr('checked',false);
//                        $('input.album[type=checkbox]').each(function () {
//                            var input = $(this);
//                            if (input.is(":checked") == true) {
//                                input.type(":checkbox:enabled").attr("checked",false);
//                            }
//                        });
                    })
                }

                function deletePhotosAlbum() {
                    $(function () {
                        var values = [];
                        albumName = $('#albumNameId').val();
                        albumDescription = $('#albumDescriptionId').val();
                        $('input.album[type=checkbox]').each(function () {
                            if ($(this).is(":checked") === true) {
                                values.push($(this).val());
                            }
                        });
                        var body = {};
                        console.log(values);
                        body.album_name = albumName;
                        body.description = albumDescription;
                        body.md5sums = values;
                        var jsondata = JSON.stringify(body);
                        console.log(jsondata);
                        $.ajax({
                            dataType: "json",
                            url: "deletephotosalbum",
                            type: 'DELETE',
                            data: jsondata,
                            success: function (responsedata, codeHttp) {
                                if (codeHttp === "success") {
                                    alert(responsedata);
                                }
                            }
                        });
                    });
                };


                function mergeAlbum() {
                    $(function () {
                        var values = [];
                        albumName = $('#updateAlbumName').val();
                        albumDescription = $('#updateAlbumDescription').val();
                        $('input.search[type=checkbox]').each(function () {
                            if ($(this).is(":checked") === true) {
                                values.push($(this).val());
                            }
                        });
                        // console.log(values);
                        var body = {};
                        body.album_name = albumName;
                        body.description = albumDescription;
                        body.md5sums = values;
                        var jsondata = JSON.stringify(body);
                        // console.log(jsondata);
                        $.ajax({
                            dataType: "json",
                            url: "updatealbum",
                            type: 'POST',
                            data: jsondata,
                            success: function (responsedata, codeHttp) {
                                if (codeHttp === "success") {
                                    alert(responsedata);
                                }
                            }
                        });
                    });
                };

                $("#updateExistingAlbum").on("show.bs.modal", function (e) {
                    updateAlbumList()
                });

                $("#updateAlbumList").on("change", function () {
                    selectedAlbum = $(this).find("option:selected").val();
                    $.ajax({
                        dataType: "json",
                        url: "/getalbum?albumName=" + selectedAlbum,
                        type: 'GET',
                        success: function (jsondata, codeHttp) {
                            // console.log(jsondata);
                            $('#updateAlbumName').val(jsondata.album_name);
                            $('#updateAlbumDescription').val(jsondata.description);
                        }
                    });
                });

                function updateAlbumList() {
                    $(function () {
                        $.ajax({
                            dataType: "json",
                            url: "/albums",
                            type: 'GET',
                            success: function (jsondata, codeHttp) {
                                //   console.log(jsondata);
                                $('#updateAlbumList').empty();
                                if (jQuery.isEmptyObject(jsondata)) {
                                    alert("No albums set.");
                                } else {
                                    $.each(jsondata, function (i, item) {
                                        $('#updateAlbumList').append('<option value="' + item + '">' + item + '</option>');
                                    });
                                }
                            }
                        })
                    })
                }

                function deleteAlbum() {
                    $(function () {
                        albumName = $('#albumNameId').val();
                        var body = {};
                        body.album_name = albumName;
                        var jsondata = JSON.stringify(body);
                        //  console.log(jsondata);
                        $.ajax({
                            dataType: "json",
                            url: "deletealbum",
                            type: 'DELETE',
                            data: jsondata,
                            success: function (responsedata, codeHttp) {
                                if (codeHttp === "success") {
                                    alert(responsedata);
                                }
                            }
                        });
                    })
                }

                function updateAlbumView() {
                    $(function () {
                        albumName = $('#albumNameId').val();
                        albumDescription = $('#albumDescriptionId').val();
                        var body = {};
                        body.album_name = albumName;
                        body.description = albumDescription;
                        var jsondata = JSON.stringify(body);
                        //  console.log(jsondata);
                        $.ajax({
                            dataType: "json",
                            url: "updatealbum",
                            type: 'POST',
                            data: jsondata,
                            success: function (responsedata, codeHttp) {
                                if (codeHttp === "success") {
                                    alert(responsedata);
                                }
                            }
                        });
                    })
                }

                function feedElementbyItems(items, tagname, classlabel, useThumbnail) {

                    $(function () {
                        $.each(items, function (i, item) {
                            if (useThumbnail) {
                                $('#' + tagname).append(
                                    '<div class="col-xs-4">' +
                                    '<label class="btn btn-primary img-check">' +
                                    '<img class="img-responsive " src="data:image/png;base64,' + item.thumbnail + '" alt="' + item.filename + '"/>' +
                                    '<input type="checkbox" id="' + item.filename + '" value="' + item.md5sum + '" class="hidden ' + classlabel + '" autocomplete="off">' +
                                    '</label>' +
                                    '<button onclick="toggler(\'' + classlabel + item.md5sum + '\')"   class="btn">+</button>' +
                                    '<div id="#' + classlabel + item.md5sum + '" style="display: none;">' +
                                    '<br>' + item.filename + '<br>' + displayExifTags(item.exiftags) +
                                    '</div>' +
                                    '</div>'
                                );
                            } else {
                                $('#' + tagname).append(
                                    '<div class="col-xs-4">' +
                                    '<label class="btn btn-primary img-check">' +
                                    '<img class="img-responsive " src="data:image/png;base64,' + item.image + '" alt="' + item.filename + '"/>' +
                                    '<input type="checkbox" id="' + item.filename + '" value="' + item.md5sum + '" class="hidden ' + classlabel + '" autocomplete="off">' +
                                    '</label>' +
                                    '<button onclick="toggler(\'' + classlabel + item.md5sum + '\')"   class="btn">+</button>' +
                                    '<div id="#' + classlabel + item.md5sum + '" style="display: none;">' +
                                    '<br>' + item.filename + '<br>' + displayExifTags(item.exiftags) +
                                    '</div>' +
                                    '</div>'
                                );
                            }
                        })
                    })
                }

                function getAlbum(albumName) {
                    $(function () {
                        $('#albumImagesFound').empty();
                        $.ajax({
                            dataType: "json",
                            url: "/getalbum?albumName=" + albumName,
                            type: 'GET',
                            success: function (jsondata, codeHttp) {
                                $('#albumNameId').val(jsondata.album_name);
                                $('#albumDescriptionId').val(jsondata.description);
                                feedElementbyItems(jsondata.records, 'albumImagesFound', 'album', true);
                            }
                        });
                    });
                }

                function toggler(divId) {
                    var x = document.getElementById('#' + divId);
                    if (x.style.display === 'none') {
                        x.style.display = 'block';
                    } else {
                        x.style.display = 'none';
                    }
                }

                //                function selectGoogleAlbums() {
                //                    $(function(){
                //                        $.ajax({
                //                            dataType: "json",
                //                            url: "/albums?type=google",
                //                            type: 'GET',
                //                            success: function (jsondata, codeHttp) {
                //                                //  console.log(jsondata);
                //                                $('#albumListId').empty();
                //                                if (jQuery.isEmptyObject(jsondata)) {
                //                                    alert("No albums set.");
                //                                } else {
                //                                    $.each(jsondata, function (i, item) {
                //                                        $('#albumListId').append('<button type="button" name="' + item +
                //                                            '" onclick="getAlbum(\'' + item + '\')" value="' + item + ' " class="btn btn-primary start">' + item + '</button>');
                //                                    });
                //                                }
                //                            }
                //                        })
                //                    })
                //                }
                //
                //                function selectFlickrAlbums() {
                //                    $(function(){
                //                        $.ajax({
                //                            dataType: "json",
                //                            url: "/albums?type=flickr",
                //                            type: 'GET',
                //                            success: function (jsondata, codeHttp) {
                //                                //  console.log(jsondata);
                //                                $('#albumListId').empty();
                //                                if (jQuery.isEmptyObject(jsondata)) {
                //                                    alert("No albums set.");
                //                                } else {
                //                                    $.each(jsondata, function (i, item) {
                //                                        $('#albumListId').append('<button type="button" name="' + item +
                //                                            '" onclick="getAlbum(\'' + item + '\')" value="' + item + ' " class="btn btn-primary start">' + item + '</button>');
                //                                    });
                //                                }
                //                            }
                //                        })
                //                    })
                //                }

                function listAlbums() {
                    $(function () {
                        $.ajax({
                            dataType: "json",
                            url: "/albums",
                            type: 'GET',
                            success: function (jsondata, codeHttp) {
                                //  console.log(jsondata);
                                $('#albumListId').empty();
                                if (jQuery.isEmptyObject(jsondata)) {
                                    alert("No albums set.");
                                } else {
                                    $.each(jsondata, function (i, item) {
                                        $('#albumListId').append('<button type="button" name="' + item +
                                            '" onclick="getAlbum(\'' + item + '\')" value="' + item + ' " class="btn btn-primary start">' + item + '</button>');
                                    });
                                }
                            }
                        })
                    })
                }

                function createalbum() {
                    $(function () {
                        var values = [];
                        var albumName = $("#albumname").val();
                        $('input.search[type=checkbox]').each(function () {
                            if ($(this).is(":checked") === true) {
                                values.push($(this).val());
                            }
                        });
                        var body = {};
                        body.album_name = albumName;
                        body.md5sums = values;
                        body.description = $("#albumDescription").val();
                        var jsondata = JSON.stringify(body);
                        //  console.log(jsondata);
                        $.ajax({
                            dataType: "json",
                            url: "createalbum",
                            type: 'POST',
                            data: jsondata,
                            success: function (responsedata, codeHttp) {
                                if (codeHttp === "success") {
                                    alert(responsedata);
                                }
                            }
                        });

                    });
                }

                function cleanDatabase() {
                    $(function () {
                        $.ajax({
                            dataType: "json",
                            url: "/cleandatabase",
                            type: "POST",
                            success: function (jsondata, codeHttp) {
                                if (codeHttp === "success") {
                                    alert("Database cleaned.");
                                }
                            }
                        })
                    })
                }

                function clean() {
                    $(function () {
                        $('#exifTagValue').val('');
                        $('#exifValue').val('');
                        $('#filename').val('');
                    })
                }

                function getExtensionList() {
                    $(function () {
                        $.ajax({
                            dataType: "json",
                            url: "/getfileextension",
                            type: 'GET',
                            success: function (jsondata, codeHttp) {
                                //  console.log(jsondata);
                                $('#extensionList').empty();
                                $.each(jsondata.Extensions, function (i, item) {
                                    $('#extensionList').append('<option value="' + item + '">' + item + '</option>');
                                });
                            }
                        })
                    })
                }


                var ExtensionSelected = "";

                function displayExifTags(exiftags) {
                    var display = "";
                    $.each(exiftags, function (i, item) {
                        display += i + ":" + item + "<br>";
                    });
                    return display;
                }

                function submitImagesSearch() {
                    $(function () {
                        var exifTag = $('#exifTagValue').val();
                        var exifValue = $('#exifValue').val();
                        var size = $('#fileSize').val();
                        $('#extensionList').each(function () {
                            ExtensionSelected = $(this).val();
                        });
                        filename = $('#filename').val();
                        $('#imagesFoundNumber').val('');
                        if (filename !== "") {
                            console.log("Calling /queryfilename?value=" + filename + "&filesize=" + size);
                            $.ajax({
                                dataType: "json",
                                url: "/queryfilename?value=" + filename + "&filesize=" + size,
                                type: 'GET',
                                success: function (jsondata, codeHttp) {
                                    //  console.log(jsondata);

                                    $('#imagesFound').empty();
                                    if (jQuery.isEmptyObject(jsondata)) {
                                        alert("No images found.");
                                    } else {
                                        $('#imagesFoundNumber').html("Found " + jsondata.length + " images.");
                                        feedElementbyItems(jsondata, 'imagesFound', 'search', false);
                                    }
                                }
                            })
                        } else {
                            if (exifTag === "" && exifValue === "" && ExtensionSelected !== "") {
                                console.log("Calling /queryextension?value=" + ExtensionSelected + "&filesize=" + size);
                                $.ajax({
                                    dataType: "json",
                                    url: "/queryextension?value=" + ExtensionSelected + "&filesize=" + size,
                                    type: 'GET',
                                    success: function (jsondata, codeHttp) {
                                        //  console.log(jsondata);

                                        $('#imagesFound').empty();
                                        if (jQuery.isEmptyObject(jsondata)) {
                                            alert("No images found.");
                                            $('#imagesFoundNumber').val('');
                                        } else {
                                            $('#imagesFoundNumber').html("Found " + jsondata.length + " images.");
                                            feedElementbyItems(jsondata, 'imagesFound', 'search', false);
                                        }
                                    }
                                })
                            } else {
                                console.log("Calling /queryexif?value=" + exifValue + "&exif=" + exifTag);
                                $.ajax({
                                    dataType: "json",
                                    url: "/queryexif?value=" + exifValue + "&exif=" + exifTag + "&filesize=" + size,
                                    type: 'GET',
                                    success: function (jsondata, codeHttp) {
                                        $('#imagesFound').empty();
                                        if (jQuery.isEmptyObject(jsondata)) {
                                            alert("No images found.");
                                            $('#imagesFoundNumber').val('');
                                        } else {
                                            $('#imagesFoundNumber').html("Found " + jsondata.length + " images.");
                                            feedElementbyItems(jsondata, 'imagesFound', 'search', false);
                                        }
                                    }
                                })
                            }
                        }
                    });
                }

                function refresh() {
                    $(function () {
                        getRegisteredMachines();
                        getExtensionList();
                    })
                }

                function getRegisteredMachines() {
                    $(function () {
                        $.ajax({
                            dataType: "json",
                            url: "/registeredslaves",
                            type: 'GET',
                            success: function (jsondata, codeHttp) {
                                //console.log(jsondata);
                                $('#machineList').empty();
                                $('#activeMachineList').empty();
                                var listContainer = $("#machineList");
                                var selectPicker = $("#activeMachineList");
                                // event.preventDefault();
                                for (i = 0; i < jsondata.length; i++) {
                                    console.log("adding " + jsondata[i].ipv4);
                                    listContainer.prepend('<li class="list-group-item">' + jsondata[i].ipv4 + '</li>');
                                    selectPicker.append('<option value="' + jsondata[i].machineId + '">' + jsondata[i].ipv4 + '</option>');
                                }
                            }
                        });
                    })
                }


                $(".search-input").keyup(function () {
                    var searchString = $(this).val();
                    //    console.log(searchString);
                    $('#jstree').jstree('search', searchString);
                });

                var MachineID = "";


                function submitSearch() {
                    $(function () {
                        var folderValue = $("#folderValue").val();
                        $('#activeMachineList').each(function () {
                            MachineID = $(this).val();
                        });
                        if (MachineID === "") {
                            alert("Please select a machine before");
                        } else {
                            console.log(MachineID);
                            $.ajax({
                                dataType: "json",
                                url: "browse?value=" + folderValue + "&machineId=" + MachineID,
                                type: 'GET',
                                success: function (jsondata, codeHttp) {
                                    console.log(codeHttp);
                                    if (jsondata.error_message !== null) {
                                        alert(jsondata.error_message);
                                    } else {
                                        if (codeHttp === 'success') {


                                            $('#jstree').jstree({
                                                'core': {
                                                    'check_callback': true
                                                },
                                                "checkbox": {
                                                    "keep_selected_style": false
                                                },
                                                "search": {
                                                    "case_insensitive": true,
                                                    "show_only_matches": true
                                                },
                                                "plugins": ["checkbox", "search"]
                                            });
                                            $("#jstree").jstree(true).settings.core.data = jsondata;
                                            $("#jstree").jstree(true).refresh();
                                        }
                                    }
                                }
                            });
                        }
                    });
                }

                function submitScan() {
                    var machineid = $('#jstree').jstree(true)._model.data['#'].original.machineid;
                    console.log(machineid);
                    var checked = $('#jstree').jstree(true).get_selected();
                    var a = [];
                    for (i = 0; i < checked.length; i++) {
                        var o = {};
                        o = checked[i];
                        a[i] = o;
                    }
                    var body = {};
                    body.folders_toscan = a;
                    body.machineid = machineid;
                    var jsondata = JSON.stringify(body);
                    // console.log(jsondata);
                    $.ajax({
                        dataType: "json",
                        url: "scan",
                        type: 'POST',
                        data: jsondata,
                        success: function (responsedata, codeHttp) {
                            if (codeHttp == "success") {
                                alert(responsedata);
                            }
                        }
                    });
                    console.log(checked);
                }
            </script>
        </div>
    </div>
</div>

</body>
</html>
